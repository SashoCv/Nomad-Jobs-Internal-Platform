# Bug: Orphan File Record on Passport Update

## Summary

When an agent updates a candidate's passport file, the old physical file is deleted from storage, but the corresponding database record in the `files` table is not updated or removed. This leaves an "orphan" record pointing to a non-existent file, causing download errors.

---

## Discovery

**Date:** 2025-01-22

**Reported Error:**
```
The file "/home/u638118030/domains/nomadjobs.cloud/public_html/api/public/storage/personPassports/8GzSW9mN4xYhVBu4u4dLwBOZgWz5HOpJ1xXRBrOg.pdf" does not exist
```

**Affected Candidate:** ID 6767 (Sagindikov Abdulaziz)

---

## Root Cause Analysis

### The Bug Location

**File:** `app/Http/Controllers/AgentCandidateController.php`
**Method:** `updateCandidateAsAgent()`
**Lines:** 439-467

### The Problem

```php
// Line 446-448: passportName is updated to NEW filename FIRST
$name = Storage::disk('public')->put('personPassports', $request->file('personPassport'));
$person->passportPath = $name;
$person->passportName = $request->file('personPassport')->getClientOriginalName();

// Line 451-459: Then we search for File record using the NEW name
$categoryForFiles = Category::where('candidate_id', $id)
    ->where('nameOfCategory', 'files from agent')
    ->first();

if ($categoryForFiles) {
    $passportFile = File::where('candidate_id', $id)
        ->where('category_id', $categoryForFiles->id)
        ->where('fileName', $person->passportName)  // BUG: Already updated to new name!
        ->first();

    if ($passportFile) {
        $passportFile->fileName = $person->passportName;
        $passportFile->filePath = $person->passportPath;
        $passportFile->save();
    }
}
```

### Why It Fails

1. `$person->passportName` is updated to the **new** filename (e.g., "SAGINDIKOV.jpeg") on line 448
2. The query on line 456-459 searches for a File record where `fileName` matches the **new** name
3. But the old File record has the **old** filename (e.g., "CV.pdf")
4. **No match is found** → `$passportFile` is `null`
5. The `if ($passportFile)` block is skipped
6. The old File record is **never updated or deleted**

### What Works vs What Doesn't

| Action | Status |
|--------|--------|
| Old physical file deleted from disk | Works (line 443) |
| New physical file saved to disk | Works (line 446) |
| Candidate record updated | Works (line 447-448) |
| File table record updated | **BROKEN** |

---

## The Fix

### Option 1: Store Old Name Before Updating (Recommended)

```php
if ($request->hasFile('personPassport')) {
    // Store old values BEFORE updating
    $oldPassportPath = $person->passportPath;
    $oldPassportName = $person->passportName;

    // Delete old passport file if exists
    if ($oldPassportPath) {
        Storage::disk('public')->delete($oldPassportPath);
    }

    // Save new file and update candidate
    $name = Storage::disk('public')->put('personPassports', $request->file('personPassport'));
    $person->passportPath = $name;
    $person->passportName = $request->file('personPassport')->getClientOriginalName();

    // Update file in files table using OLD name
    $categoryForFiles = Category::where('candidate_id', $id)
        ->where('nameOfCategory', 'files from agent')
        ->first();

    if ($categoryForFiles) {
        $passportFile = File::where('candidate_id', $id)
            ->where('category_id', $categoryForFiles->id)
            ->where('fileName', $oldPassportName)  // Use OLD name to find the record
            ->first();

        if ($passportFile) {
            $passportFile->fileName = $person->passportName;
            $passportFile->filePath = $person->passportPath;
            $passportFile->save();
        }
    }
}
```

### Option 2: Search by filePath Instead of fileName

```php
if ($categoryForFiles) {
    $passportFile = File::where('candidate_id', $id)
        ->where('category_id', $categoryForFiles->id)
        ->where('filePath', $oldPassportPath)  // Search by old path instead
        ->first();

    // ... rest of the code
}
```

### Option 3: Delete Old Record and Create New One

```php
if ($categoryForFiles) {
    // Delete old file record
    File::where('candidate_id', $id)
        ->where('category_id', $categoryForFiles->id)
        ->where('autoGenerated', 1)
        ->delete();

    // Create new file record
    $newFile = new File();
    $newFile->candidate_id = $id;
    $newFile->category_id = $categoryForFiles->id;
    $newFile->fileName = $person->passportName;
    $newFile->filePath = $person->passportPath;
    $newFile->autoGenerated = 1;
    $newFile->company_restriction = 0;
    $newFile->save();
}
```

---

## Additional Context

### Difference Between Admin and Agent Forms

| Feature | Admin Form | Agent Form |
|---------|------------|------------|
| Passport filename | Adds `_passport` suffix | Uses original filename |
| Upload handler | `addCandidate.ts` utility | Direct API mutation |
| File location | `web-nomad-cloud/src/utils/_DOCUMENT_GENERATION/addCandidate.ts:65` | `web-nomad-cloud/src/hooks/mutations/candidate/use-add-candidate-as-agent/` |

### Database Tables Involved

- **`candidates`** - Main candidate record with `passportPath` and `passportName` columns
- **`files`** - Document records with `fileName`, `filePath`, `candidate_id`, `category_id`
- **`categories`** - Category definitions, agent files use `nameOfCategory = 'files from agent'`

### Example of Orphan Record

```
files table:
- id: 221055
- candidate_id: 6767
- category_id: 10245
- fileName: "Сагиндиков Абдулазиз CV.pdf"
- filePath: "personPassports/8GzSW9mN4xYhVBu4u4dLwBOZgWz5HOpJ1xXRBrOg.pdf"  <- File doesn't exist
- autoGenerated: 1
- created_at: 2025-12-10 15:04:20

candidates table:
- id: 6767
- passportPath: "personPassports/WxaBj280OxX4FlWhYlttizA8MxZu93tX8MsGabGb.jpg"  <- Current file
- passportName: "SAGINDIKOV.jpeg"
- updated_at: 2025-12-29 10:04:29
```

---

## Cleanup: Fixing Existing Orphan Records

To find and clean up existing orphan file records:

```php
// Find orphan records (files in DB but not on disk)
$files = File::where('filePath', 'LIKE', 'personPassports/%')->get();

foreach ($files as $file) {
    $fullPath = storage_path('app/public/' . $file->filePath);
    if (!file_exists($fullPath)) {
        // Log or delete the orphan record
        Log::warning("Orphan file record found: ID {$file->id}, Path: {$file->filePath}");
        // $file->delete(); // Uncomment to actually delete
    }
}
```

---

## Timeline of the Specific Incident

| Date | Action | User |
|------|--------|------|
| 2025-12-10 15:04:20 | Candidate added with CV file uploaded as passport | Agent Dildora Mamadalieva |
| 2025-12-29 10:04:29 | Passport updated with correct file | Unknown |
| 2025-01-22 | Error reported when trying to download old document | - |

---

## Related Files

- `app/Http/Controllers/AgentCandidateController.php` - Contains the bug
- `app/Models/File.php` - File model
- `app/Models/Category.php` - Category model
- `web-nomad-cloud/src/components/modules/AddCandidateAsAgent/` - Agent form frontend
- `web-nomad-cloud/src/utils/_DOCUMENT_GENERATION/addCandidate.ts` - Admin upload logic (reference)
