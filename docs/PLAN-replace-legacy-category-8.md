# Plan: Replace Legacy category_id=8 System

> **Status:** Future implementation — not started
> **Created:** 2026-02-09
> **Priority:** Low — current system works, this is architectural improvement

## Context

The system uses a single global category (ID=8, `candidate_id=NULL`, `isGenerated=1`) as a bucket for ALL auto-generated legal documents across ALL candidates. This works but has architectural problems:

- **Hardcoded ID** — `category_id=8` is hardcoded in 2 backend files and 1 frontend constant
- **No per-candidate isolation** — 61,636 files from 4,875 candidates share one category
- **Inconsistent query model** — `FileController::show()` returns cat-8 files for staff (no category filter) but the category itself is never in the response (since `candidate_id=NULL`). Frontend receives files with no matching category metadata
- **Can't filter by contract** — all auto-generated docs are in one category. No way to group "90-day contract docs" vs "extension docs" visually
- **Position files mixed in** — 1,893 position-linked files (`deleteFile=2`) share the same category as 59,133 contract docs (`deleteFile=0`), despite having completely different lifecycle rules

### Production Data Profile (as of 2026-02-09)

| Metric | Value |
|---|---|
| Total files in category 8 | 61,636 |
| Unique candidates | 4,875 |
| Avg files per candidate | 12.6 |
| `deleteFile=0` (contract docs) | 59,133 (95.9%) |
| `deleteFile=2` (position docs) | 1,893 (3.1%) |
| `company_restriction=1` (staff-only) | 52,588 (85.3%) |
| `company_restriction=0` (company-visible) | 9,048 (14.7%) |
| Files with `contract_id` | 61,519 (99.8%) |

### Current Touchpoints

**Backend (2 files with hardcoded `category_id=8`):**
- `app/Http/Controllers/PositionController.php` — line 142
- `app/Http/Resources/PostJobPosition.php` — line 45

**Backend (uses `autoGenerated` / `deleteFile` flags):**
- `app/Services/CandidateService.php` — `cleanupAutoGeneratedFiles()` deletes `autoGenerated=1 AND deleteFile=0`
- `app/Http/Controllers/PositionController.php` — `destroyDocumentForPosition()` deletes `deleteFile=2`

**Frontend (category_id="8" constant):**
- `src/constants/categoryIds.ts` — `CATEGORY_IDS.AUTO_GENERATED_DOCUMENTS = "8"`
- `src/utils/_DOCUMENT_GENERATION/helpers/uploadDocuments.ts` — uses the constant
- `src/utils/candidate/handleDocumentUpload.ts` — receives category_id param

**Frontend (isGenerated UI logic):**
- `src/features/documents/documents-manager.tsx` — sorts generated categories first, prevents deletion
- `src/features/documents/components/category-section/category-section.tsx` — SYSTEM badge, shield icon, disables upload/edit/delete, blocks drag-drop
- `src/features/documents/components/file-card/file-card.tsx` — hides move/delete actions for generated files

---

## Architecture: Per-Candidate Generated Documents Category

Replace the single global category with per-candidate categories, following the same pattern as "files from agent".

### New Category Structure

Each candidate gets an auto-generated documents category created at candidate creation time:

```
Category {
  candidate_id: <candidate_id>,
  nameOfCategory: "генерирани документи",
  isGenerated: 1,
  visibleToRoles: [GENERAL_MANAGER, MANAGER, OFFICE, HR, OFFICE_MANAGER, RECRUITERS, FINANCE]
  // NOT visible to AGENT or COMPANY — same as current behavior
}
```

### Phase 1: Backend — Category Creation

**1.1 Add to DefaultCandidateCategory enum**

**File:** `app/Enums/DefaultCandidateCategory.php`

Add a new case:
```php
case GENERATED_DOCUMENTS = 'генерирани документи';
```

With definition: `isGenerated=1`, visible to all staff roles (not agents, not companies).

**1.2 Update CandidateService::createDefaultCategory()**

**File:** `app/Services/CandidateService.php`

When creating a candidate, also create the "генерирани документи" category with `isGenerated=1` and staff-only roles.

**1.3 Create helper: getOrCreateGeneratedDocsCategory()**

**File:** `app/Services/CandidateService.php` (new method)

```php
public static function getOrCreateGeneratedDocsCategory(int $candidateId): Category
{
    return Category::firstOrCreate(
        ['candidate_id' => $candidateId, 'nameOfCategory' => 'генерирани документи'],
        ['isGenerated' => 1]
    );
    // + attach staff roles if newly created
}
```

This replaces all hardcoded `category_id=8` references.

### Phase 2: Backend — Replace Hardcoded References

**2.1 PositionController::update()**

**File:** `app/Http/Controllers/PositionController.php` (line 142)

```php
// BEFORE:
$file->category_id = 8;

// AFTER:
$category = CandidateService::getOrCreateGeneratedDocsCategory($candidate->id);
$file->category_id = $category->id;
```

**2.2 PostJobPosition::storeInFilesJobPosition()**

**File:** `app/Http/Resources/PostJobPosition.php` (line 45)

Same change — use the helper instead of hardcoded 8.

**2.3 FileController::show() — no code change needed**

**File:** `app/Http/Controllers/FileController.php` (lines 249-286)

Currently for staff: returns ALL files but only per-candidate categories. This means cat-8 files have no matching category in the response.

Once categories are per-candidate, the existing `where('candidate_id', $id)` query will naturally find the per-candidate "генерирани документи" category and its files. No code change required.

### Phase 3: Frontend — Remove Hardcoded Constant

**3.1 Update uploadDocuments()**

**File:** `src/utils/_DOCUMENT_GENERATION/helpers/uploadDocuments.ts`

Instead of passing `CATEGORY_IDS.AUTO_GENERATED_DOCUMENTS` ("8"), let the backend determine the category.

**Recommended: Option A** — add backend logic to `FileController::store()`:
```php
if ($request->autoGenerated == 1 && !$request->category_id) {
    $category = CandidateService::getOrCreateGeneratedDocsCategory($request->candidate_id);
    $file->category_id = $category->id;
}
```

This way the frontend just sets `autoGenerated=1` without needing to know the category ID.

**3.2 Remove CATEGORY_IDS constant**

**File:** `src/constants/categoryIds.ts`

Delete `AUTO_GENERATED_DOCUMENTS: "8"` — no longer needed.

**3.3 Update handleDocumentUpload()**

**File:** `src/utils/candidate/handleDocumentUpload.ts`

Make `category_id` optional. When `autoGenerated=1`, don't send `category_id` — let backend handle it.

### Phase 4: Data Migration

**4.1 Create migration: per-candidate generated docs categories**

For each of the 4,875 candidates with files in category 8:
1. Create a "генерирани документи" category with `candidate_id=X`, `isGenerated=1`
2. Attach staff roles
3. Update all files: `SET category_id = <new_cat_id> WHERE candidate_id = X AND category_id = 8`

```php
// Migration pseudocode
$candidateIds = DB::table('files')
    ->where('category_id', 8)
    ->distinct()
    ->pluck('candidate_id');

foreach ($candidateIds->chunk(100) as $chunk) {
    foreach ($chunk as $candidateId) {
        $category = Category::create([
            'candidate_id' => $candidateId,
            'nameOfCategory' => 'генерирани документи',
            'isGenerated' => 1,
        ]);
        $category->visibleToRoles()->attach([
            Role::GENERAL_MANAGER, Role::MANAGER, Role::OFFICE,
            Role::HR, Role::OFFICE_MANAGER, Role::RECRUITERS, Role::FINANCE,
        ]);

        DB::table('files')
            ->where('candidate_id', $candidateId)
            ->where('category_id', 8)
            ->update(['category_id' => $category->id]);
    }
}
```

**4.2 Delete old global category 8**

After all files are migrated, delete category 8 and its role associations.

**4.3 Batch size consideration**

61,636 files across 4,875 candidates. Process in chunks of 100 candidates to avoid memory issues and long locks.

### Phase 5: Cleanup

- Delete `CATEGORY_IDS` constant from frontend
- Remove `PostJobPosition::storeInFilesJobPosition()` if no longer needed (inline logic instead)
- Update any tests referencing category_id=8

---

## Risk Assessment

| Risk | Mitigation |
|------|-----------|
| Migration locks tables during file update | Process in batches of 100 candidates |
| Frontend/backend deploy timing mismatch | Backend Option A (auto-assign category) means frontend change is backward-compatible |
| 117 files without contract_id | These are orphans — handle separately or leave in global category |
| Rollback needed | Keep category 8 until migration verified, delete only after confirmation |

## Verification

1. After migration: `SELECT COUNT(*) FROM files WHERE category_id = 8` should return 0
2. Staff view: "генерирани документи" appears per candidate with correct files
3. Agent view: generated docs category NOT visible (same as before)
4. Document generation: new docs go to per-candidate category
5. Position document update: files go to per-candidate category
6. `cleanupAutoGeneratedFiles()`: still works (queries by `candidate_id` + `autoGenerated`, not by `category_id`)

## Files to Modify

| File | Change |
|------|--------|
| `app/Enums/DefaultCandidateCategory.php` | Add GENERATED_DOCUMENTS case |
| `app/Services/CandidateService.php` | Add `getOrCreateGeneratedDocsCategory()`, update `createDefaultCategory()` |
| `app/Http/Controllers/PositionController.php` | Replace hardcoded 8 with helper |
| `app/Http/Resources/PostJobPosition.php` | Replace hardcoded 8 with helper |
| `app/Http/Controllers/FileController.php` | Auto-assign category for autoGenerated files |
| `database/migrations/` | New migration to create per-candidate categories + remap files |
| `src/constants/categoryIds.ts` | Delete AUTO_GENERATED_DOCUMENTS |
| `src/utils/_DOCUMENT_GENERATION/helpers/uploadDocuments.ts` | Stop sending category_id for auto-generated |
| `src/utils/candidate/handleDocumentUpload.ts` | Make category_id optional |
